// backend/middleware/errorHandler.ts

import { Request, Response, NextFunction } from 'express';

/**
 * Centralized error handling middleware for API responses.
 * Ensures consistent error structure, logging, and security best practices.
 * Should be the last middleware in the stack.
 */
export function errorHandler(
  err: any,
  req: Request,
  res: Response,
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  next: NextFunction
): void {
  // Log error for audit and monitoring (e.g., Sentry, console)
  if (process.env.NODE_ENV !== 'production') {
    // eslint-disable-next-line no-console
    console.error('API Error:', err);
  }
  if ((global as any).Sentry) {
    (global as any).Sentry.captureException(err);
  }

  // Determine status code
  const status = err.status && typeof err.status === 'number' ? err.status : 500;

  // Never leak sensitive error details in production
  const isProd = process.env.NODE_ENV === 'production';
  const message =
    (isProd && status === 500)
      ? 'An unexpected error occurred. Please try again later.'
      : err.message || 'Internal server error';

  // Ensure no stack traces or sensitive info are sent to client
  res.status(status).json({
    message,
    code: err.code || undefined,
    status,
  });
}

export default errorHandler;