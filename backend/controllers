// backend/controllers/balanceController.ts

import { Request, Response, NextFunction } from 'express';
import { getBalancesForUser } from '../services/balanceService';
import { logAuditEvent } from '../utils/auditLogger';

/**
 * Controller to handle GET /api/balances
 * Fetches real-time balances for all linked accounts of the authenticated user.
 * Ensures no outdated/cached balances are returned on error.
 * Logs access for audit purposes.
 */
export async function getAccountBalances(
  req: Request,
  res: Response,
  next: NextFunction
): Promise<void> {
  const userId = req.session?.userId;

  if (!userId) {
    // Not authenticated; prompt re-authentication
    res.status(401).json({ message: 'Authentication required.' });
    return;
  }

  try {
    // Fetch real-time balances from the service layer
    const accounts = await getBalancesForUser(userId);

    // Audit log: successful access
    logAuditEvent({
      userId,
      action: 'VIEW_BALANCES',
      details: { accountCount: accounts.length },
      ip: req.ip,
      userAgent: req.headers['user-agent'],
    });

    res.status(200).json({ accounts });
  } catch (error: any) {
    // Audit log: failed access
    logAuditEvent({
      userId,
      action: 'VIEW_BALANCES_FAILED',
      details: { error: error?.message || 'Unknown error' },
      ip: req.ip,
      userAgent: req.headers['user-agent'],
    });

    // Do not return outdated/cached balances on error
    res.status(error?.status || 500).json({
      message:
        error?.message ||
        'Unable to retrieve account balances at this time. Please try again later.',
    });
  }
}

export default {
  getAccountBalances,
};